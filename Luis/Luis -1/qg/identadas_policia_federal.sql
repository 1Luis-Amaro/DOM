

--WITH cteMenuNivel(id,Nome,Nivel,NomeCompleto)
--AS
--(
--    -- Ancora
--    SELECT id,Nome,1 AS 'Nivel',CAST(Nome AS VARCHAR(255)) AS 'NomeCompleto' 
--    FROM tbMenu WHERE idPai IS NULL
--    
--    UNION ALL
    
--    -- Parte RECURSIVA
--    SELECT 
--        m.id,m.Nome,c.Nivel + 1 AS 'Nivel',
--        CAST((c.NomeCompleto + '/' + m.Nome) AS VARCHAR(255)) 'NomeCompleto' 
--    FROM tbMenu m INNER JOIN cteMenuNivel c ON m.idPai = c.id
    
--)
--SELECT Nivel,NomeCompleto FROM cteMenuNivel




WITH cteMenuNivel(segment1,inventory_item_id,qty, formula_id, recipe_id, organization_id, Nivel)
AS
(
    -- Ancora
    SELECT msi.segment1,
           fmd.inventory_item_id,
           CASE
              WHEN msip.planning_make_buy_code  = 1 THEN
                 1
              WHEN fmd.scale_type = 0 THEN
                 (fmd.qty / fm.qty) / vr.std_qty
              WHEN fmd.scale_type = 1 THEN
                 (fmd.qty / fm.qty)
              ELSE
                 (fmd.qty / fm.qty)
           END qty,
           --1 qty,
           fmd.formula_id,
           gr.recipe_id,
           fmd.organization_id,
           0 as Nivel
      FROM apps.fm_form_mst_b fms,
           apps.fm_matl_dtl   fm,
           apps.fm_matl_dtl   fmd,
           apps.gmd_recipes_b gr,
           apps.gmd_recipe_validity_rules vr,
           apps.mtl_system_items_b msi,
           apps.mtl_system_items_b msip,
           (SELECT MIC.INVENTORY_ITEM_ID,
                   MIC.ORGANIZATION_ID,
                   MIC.CATEGORY_SET_NAME,
                   MIC.CATEGORY_CONCAT_SEGS CATEGORIA
              FROM APPS.MTL_ITEM_CATEGORIES_V MIC, APPS.MTL_CATEGORIES_V MC
             WHERE MC.CATEGORY_ID = MIC.CATEGORY_ID
               AND MIC.CATEGORY_SET_NAME IN ('Inventory')) INVENTARIO
     WHERE fmd.line_type              = -1                   AND           
           fmd.formula_id             = fm.formula_id        AND
           fmd.organization_id        = fm.organization_id   AND
           fmd.CONTRIBUTE_YIELD_IND   = 'Y' AND
--           
           /**** performance ****/
           vr.preference                  = 1               AND   
           vr.delete_mark                 = 0               AND   
           vr.recipe_use                  = 0               AND -- 0 = Produção - 2=Custos 
           vr.validity_rule_status       in (700,900)       AND 
           vr.recipe_id                   = gr.recipe_id    AND
           vr.start_date                 <= sysdate         AND
           vr.end_date                   is NULL            AND           
           /**** performance ****/
--           
           gr.recipe_id                 = (select max(gr1.recipe_id)
                                             FROM apps.gmd_recipes_b gr1,
                                                  apps.gmd_recipe_validity_rules vr1
                                            WHERE /**** Performance ****/
                                                  vr1.delete_mark           = 0                  AND
                                                  --vr1.preference            = 1                  AND      
                                                  vr1.recipe_use            = 0 /*Custos*/      AND
                                                  vr1.validity_rule_status in (700,900)          AND
                                                  vr1.start_date           <= sysdate            AND
                                                  vr1.end_date             is null               AND
                                                  vr1.organization_id       = fm.organization_id AND
                                                  vr1.recipe_id             = gr1.recipe_id      AND
                                                  /**** Performance ****/
                                                  gr1.recipe_status        in (700,900)          AND
                                                  gr1.formula_id            = fm.formula_id) AND
--                                                  
           gr.recipe_status            in (700,900)             AND
           gr.formula_id                = fm.formula_id         AND
--           
          -- NVL(fms.formula_class,'SM') <> 'TING-PMC'            AND
           fms.formula_id               = fm.formula_id         AND
           fm.line_type                 = 1                     AND
           fm.inventory_item_id         = msi.inventory_item_id AND
           fm.organization_id           = msi.organization_id   AND
           msip.inventory_item_id       = fmd.inventory_item_id AND
           msip.organization_id         = msi.organization_id   AND
           msip.segment1 <> msi.segment1 and
           -- MSI.SEGMENT1 = 'AK0001L.01'
           --           
           --
           MSI.ORGANIZATION_ID       = INVENTARIO.ORGANIZATION_ID AND
           MSI.INVENTORY_ITEM_ID     = INVENTARIO.INVENTORY_ITEM_ID AND
         --  MSI.item_type like 'ACA%' AND
           --INVENTARIO.CATEGORIA LIKE 'ACA%REF%' /*and
          -- 
          (msi.segment1 in
       ('ACTE-00001.33',
'AG-0001BR.01',
'A-I101575-MF.W20',
'ALF100RTU.22',
'ALF200RTU.22',
'AM-BL.20',
'AM-BL.48',
'AMOSTRA27',
'AMOSTRA28',
'A-M202975-HH.22',
'A-M203186-HH.22',
'APSA-00001.10',
'APSB-00001.51',
'AP13516',
'AP13517',
'AP13518',
'AP14652',
'AP14653',
'AP14654',
'AP14655',
'AP14656',
'AP14657',
'AP14659',
'AP14669',
'AP14675',
'AP14677',
'AP14678',
'AP14686',
'AP14687',
'AP14688',
'AP14692',
'AP14703',
'AP14705',
'AP20431',
'AP3306C.22',
'AP64339',
'AP64461',
'A-R520024.22',
'AT138BR-BL.01',
'AT68HS-P.01',
'AT880L.01',
'AUSA-00002.22',
'AUSA-0001.INT',
'A242.15',
'A652.18',
'A722.18',
'A722.28',
'BC4205NP/DR',
'BMSB-00002.22',
'BOB-002',
'BS-02.INT',
'BS-02.11',
'BUF.45',
'BUF.77',
'BYJ-300.52',
'CA285.77',
'CA636.47',
'CA636.48',
'CA682JD.45',
'CA682JD.77',
'CA682.45',
'CA682.97',
'CA708B.70',
'CFLADD.INT',
'CFZN.45',
'CF51HD.C6',
'CF51HD.45',
'CF51HD.68',
'CF51HD.77',
'CF700A.97',
'CF700B.68',
'CG-1482S.11',
'CK140A.45',
'CK166M.C6',
'CK166MS.C6',
'CK166MS.57',
'CK166M.68',
'CK171-11.70',
'CK171-11.97',
'CK39F.63',
'CK39F.77',
'CK611L.C6',
'CK611LS.C6',
'CK611LS.68',
'CK611L.68',
'CK611L.70',
'CK611L.97',
'CLSA-00001.51',
'CLTD-00001.10',
'CL-502.INT',
'CL-512.INT',
'CL-513.INT',
'CL-530.INT',
'CL-531.INT',
'CL-533.INT',
'CL-537.INT',
'CL-542.INT',
'CL-544.INT',
'CL-546.INT',
'CL-549.INT',
'CL-556.INT',
'CM-002.INT',
'CM-068.INT',
'CM-074.INT',
'CM-076.INT',
'CM-077.INT',
'CM-078.INT',
'CM-108.INT',
'CM-110.INT',
'CM-112.INT',
'CM-207.INT',
'COEB-00001.48',
'COEB-00002.22',
'COEB-00003.79',
'COEB-00004.S5',
'COEB-00006.77',
'COR1777.57',
'COR1777.79',
'COR851LC.C6',
'CR-600.11',
'CR-603.11',
'CR935.57',
'CS100.C6',
'CS100.45',
'CS100.68',
'CS100.77',
'C083-4090.04',
'C210-0010.11',
'C210-0010.32',
'C210-0020.INT',
'C210-0020.02',
'C210-0020.11',
'C210-0020.32',
'C210-0901.32',
'C210-0951.32',
'C210-0999.INT',
'C210-1052.32',
'C210-3019.32',
'C210-3087.02',
'C210-3087.16',
'C210-9602.INT',
'C275-3123.16',
'C551-0220.18',
'C551-9446.17',
'C551-9446.28',
'C551-9800.17',
'C562-1141.04',
'C562-1142.01',
'C562-1142.04',
'C562-1143.06',
'C562-1150.17',
'C850-0101.51',
'C850-0600.04',
'C850-0600.10',
'C850-0900.04',
'C850-0900.10',
'C850-1100.04',
'C850-3800.04',
'C850-3800.10',
'C850-5000.11',
'DCH3070.11',
'DCH3085.11',
'DCH3095.INT',
'DCH3095.11',
'DE-999',
'DI9-P.01',
'DMX210.8V',
'DMX212.8V',
'DMX218.8V',
'DMX219.8V',
'DUL1800.17',
'DUL1800.18',
'DUL1800.28',
'DV4790.04',
'DX78.3A',
'D803.11',
'D807N.20',
'D807.04',
'D807.10',
'D807.20',
'D812.04',
'D832.11',
'D837.04',
'D837.10',
'D8401.65',
'D851.04',
'D863N.11',
'D863.11',
'D868N.04',
'D868.04',
'D8745.11',
'D8746.11',
'EDADDWETT.38',
'EDADDWETT.65',
'EM-001',
'EM-004',
'EM-011',
'EM-017',
'FBR004.10',
'FBR004.11',
'FBR011.10',
'FBR012.48',
'FBR017.10',
'FBR030.INT',
'FBR031.INT',
'FBR033.INT',
'FBR0900.20',
'FBR262.INT',
'FBR375.20',
'FBR506.77',
'FBR516.77',
'FBR521.10',
'FBR522.77',
'FBR533.20',
'FBR560.11',
'FBR571.11',
'FBR572.10',
'FBR800.77',
'FBR905.20',
'FBR906.20',
'FD.45',
'FD.77',
'FIBB-00022.C4',
'FIBB-00022.C8',
'FIBB-00022.48',
'FIBB-00031.C4',
'FIBB-00031.C8',
'FIBB-00031.48',
'FIBB-00034.48',
'FIBB-00047.C4',
'FIBB-00047.C8',
'FIBD-00001.C4',
'FIBD-00001.C8',
'FIBD-00001.48',
'FIBD-00036.C4',
'FIBD-00036.C8',
'FIBD-00036.48',
'FIEB-00002.22',
'FIEB-00004.S5',
'FIEB-00004.22',
'FIEB-00005.22',
'FIEB-00006.S5',
'FIEB-00007.57',
'FIMI-00001.22',
'FIMI-00002.22',
'FIMI-00002.48',
'FIMI-00003.22',
'FIRA-00002.22',
'FIRB-00002.22',
'FIRC-00003.22',
'FIRC-00011.22',
'FIRC-00012.22',
'FIRC-00013.22',
'FIRC-00014.22',
'FIRC-00015.22',
'FIRC-00016.22',
'FIRC-00017.22',
'FIRC-00018.22',
'FIRD-00007.22',
'FIRD-00008.22',
'FIRD-00009.22',
'FISA-00001.C8',
'FISA-00001.22',
'FISA-00001.48',
'FISA-00002.C8',
'FISA-00002.22',
'FISA-00002.48',
'FISA-00003.C8',
'FISA-00003.22',
'FISA-00003.48',
'FISA-00004.C8',
'FISA-00004.22',
'FISA-00004.48',
'FISA-00005.10',
'FISA-00006.10',
'FISA-00007.22',
'FISA-00008.22',
'FISB-00004.11',
'FISB-00005.11',
'FL-001',
'FL-002',
'FL-003',
'FL-004',
'FL-005',
'FL-007',
'FL-010',
'FL-011',
'FL-012',
'FL-013',
'FL-014',
'FL-017',
'FL-018',
'FL-032',
'F300.INT',
'F301.INT',
'F302.INT',
'F304.INT',
'F305.INT',
'F306.INT',
'F308.INT',
'F309.INT',
'F310.INT',
'F311.INT',
'F312.INT',
'F313.INT',
'F314.INT',
'F315.INT',
'F317.INT',
'F318.INT',
'F318.20',
'F319.INT',
'F320.INT',
'F321.INT',
'F323.INT',
'F324.INT',
'F325.INT',
'F349.11',
'F359.11',
'F361.10',
'F361.11',
'F361.16',
'F362.11',
'F363.11',
'F366.11',
'F369.10',
'F371.10',
'F372.04',
'F372.10',
'F372.20',
'F372.48',
'F373.10',
'F373.20',
'F381.11',
'GXA90014.04',
'GXH18001.22',
'HEAC.45',
'HOSA-00001.48',
'HOSA-00002.48',
'HYEB-00001.S5',
'HYEB-00002.79',
'HYEB-00003.71',
'HYEB-00003.97',
'HYEB-00004.40',
'HYEB-00004.57',
'HYEB-00005.57',
'HYEB-00005.77',
'HYEB-00005.97',
'HYEB-00007.57',
'HYEB-00007.63',
'HYEB-00008.45',
'HYRA-00001.K20',
'HYRC-00001.57',
'HYRC-00002.57',
'HYRC-00003.57',
'HYRC-00004.57',
'HYRC-00004.97',
'HYRC-00005.97',
'HYRC-00006.97',
'HYRC-00007.97',
'HYRC-00008.57',
'HYRC-00009.97',
'HYRD-00001.57',
'HYRD-00002.57',
'HYRD-00003.57',
'HYRD-00004.22',
'ID5200.25',
'IND910090A.86',
'IND910090.86',
'INRA-00001.4P',
'INRB-00001.63',
'INRB-00003.97',
'INRC-00001.57',
'INRC-00003.63',
'INRC-00004.63',
'INRC-00005.97',
'INRC-00006.C6',
'INRC-00006.57',
'INRC-00006.97',
'INRC-00010.63',
'INRC-00012.C6',
'INRC-00012.57',
'INRD-00004.97',
'INRD-00008.57',
'INRD-00008.77',
'INRD-00012.97',
'INRD-00014.57',
'INRD-00014.97',
'INRD-00015.97',
'INRO-00001.77',
'INRO-00001.97',
'INRO-00002.C83',
'INRO-00002.63',
'INRO-00002.77',
'INSP-00001.97',
'INSP-00002.97',
'INSP-00003.50',
'INTOE-200.47',
'INTOE-201.47',
'INTOE-202.47',
'INTOE-203.47',
'INTOE-205.47',
'INTOE-206.47',
'INTOE-207.47',
'INTOE-210.47',
'INTOE-211.01',
'IN601.11',
'IVEB-00001.T8',
'IVEB-00002.79',
'IVRA-00001.22',
'IVRB-00001.57',
'IVRC-00002.63',
'IVRC-00003.57',
'IVRC-00006.63',
'IVRC-00007.63',
'IVRC-00008.63',
'IVRC-00009.97',
'IVRD-00002.63',
'IVRD-00003.57',
'IVRO-00002.57',
'IVRO-00002.97',
'IVSA-00002.48',
'IVSA-00003.C8',
'IVSA-00004.48',
'IVSA-00011.10',
'IVSB-00001.65',
'IVTB-00027.48',
'I-00900.63',
'I-00900.77',
'I-00902.48',
'I-00902.50',
'I-00911.S5',
'LT0001SDD.10',
'LT0001SDD.48',
'LT0001SDD.50',
'LT0302SSA.48',
'LT0303SSA.48',
'LT0306SSA.48',
'LT0314SSA.48',
'LT0317SSA.48',
'LT0330SSA.48',
'LT11002SDD.50',
'LT1366SDD.50',
'LT1367SDD.10',
'LT1367SDD.50',
'LT1453SDD.C4',
'LT1453SDD.10',
'LT1453SDD.48',
'LT1453SDD.50',
'LT1462SDD.48',
'LT1462SDD.50',
'LT1490SDD.48',
'LT1491SDD.48',
'LT1669SDD.50',
'LT1927SDD.48',
'LT1927SDD.50',
'LT1938SDD.51',
'LT1965SDD.10',
'LT5715SDD.50',
'LT5717SDD.50',
'LT5718SDD.38',
'LT5718SDD.77',
'LT5728SDD.50',
'LT5729SDD.48',
'LT5729SDD.50',
'LT5730SDD-A.48',
'LT5731SDD.10',
'LT5750SDD.10',
'LT5750SDD.48',
'LT5750SDD.50',
'LT5751SDD.65',
'MBEB-00001.97',
'MBEB-00002.K18',
'MBEB-00002.40',
'MBEB-00003.79',
'MBEB-00004.K18',
'MBEB-00006.S5',
'MBEB-00007.71',
'MBEB-00007.97',
'MBEB-00008.K20',
'MBEB-00008.6A',
'MBEB-00008.65',
'MBRD-00001.22',
'MBRD-00001.58',
'MBRD-00002.58',
'MBRD-00003.58',
'MBRD-00004.58',
'MBRD-00004.65',
'MBRD-00004.70',
'MBRD-00005.58',
'MBRD-00006.58',
'MBRD-00006.61',
'MBRD-00007.58',
'MBRD-00007.60',
'MBRD-00008.58',
'MBRZ-00001.S5',
'MBRZ-00001.71',
'MBRZ-00002.S5',
'MBRZ-00002.71',
'MBRZ-00003.S5',
'MBRZ-00003.71',
'MBRZ-00004.22',
'MBRZ-00005.S5',
'MBRZ-00005.58',
'MBRZ-00006.S5',
'MBRZ-00006.58',
'MBRZ-00007.S5',
'MBRZ-00007.71',
'MBRZ-00008.74',
'MBRZ-00009.S5',
'MBRZ-00009.71',
'MBRZ-00011.6A',
'MBRZ-00012.6A',
'MBRZ-00013.97',
'MBRZ-00014.71',
'MBRZ-00015.58',
'MBSA-00001.9K',
'MBSB-00001.10',
'MBSB-00002.11',
'MESA-00001.K80',
'MESA-00001.58',
'MESA-00002.K80',
'MESA-00002.58',
'MESA-00003.K16',
'MESA-00003.K18',
'MESA-00003.46',
'MESA-00003.58',
'MESA-00004.K16',
'MESA-00004.K18',
'MESA-00004.46',
'MESA-00004.58',
'MESA-00005.K80',
'MESA-00005.22',
'MESA-00005.58',
'MZD7330.38',
'MZD7330.65',
'NA101JD.48',
'NIEB-00001.22',
'NIEB-00002.22',
'NIEB-00004.22',
'NIEB-00005.22',
'NIEB-00006.22',
'NIRA-00001.22',
'NIRC-00002.22',
'NIRC-00003.22',
'NIRC-00004.22',
'NIRC-00005.22',
'NIRC-00006.22',
'NIRC-00007.22',
'NIRC-00008.22',
'NIRD-00001.22',
'NIRD-00002.22',
'NIRD-00003.22',
'NISA-T6000.22',
'NISA-00001.22',
'NISA-00002.22',
'NISA-00004.22',
'NISA-00004.48',
'NISA-00005.22',
'NISA-00009.22',
'NISA-00010.22',
'NISA-00011.22',
'NISA-00012.22',
'NISA-00013.22',
'NISA-00013.48',
'NISB-00001.22',
'NLSA-00001.22',
'OTEB-00009.S5',
'OTEB-00011.S5',
'OTEB-00013.97',
'OTRA-00001.S5',
'OTRC-00001.57',
'OTRC-00002.63',
'OTRD-00004.57',
'PALA-00001.47',
'PALA-00003.38',
'PALA-00005.38',
'PALA-00007.38',
'PALA-00008.38',
'PALA-00009.47',
'PALA-00009.51',
'PALA-00011.38',
'PALA-000118.05',
'PALA-000118.47',
'PALA-00013.22',
'PALA-00014.74',
'PALA-00018.48',
'PALA-00028.05',
'PALA-00029.51',
'PALA-00032.01',
'PALA-00045.01',
'PALA-00048.04',
'PALA-00052.01',
'PALA-00053.01',
'PALA-00054.01',
'PALA-00055.48',
'PALA-00060.51',
'PALA-00061.51',
'PALA-00063.48',
'PALA-00063.51',
'PALA-00093.22',
'PALA-00094.22',
'PALA-00102.05',
'PALA-00102.38',
'PALA-00102.47',
'PALA-00104.22',
'PALA-00104.38',
'PALA-00104.51',
'PALA-00105.38',
'PALA-00105.51',
'PALA-00109.01',
'PALA-00111.63',
'PALA-00113.38',
'PALA-00114.05',
'PALA-00116.51',
'PALA-00118.K18',
'PALA-00118.51',
'PALA-00119.51',
'PALA-00121.51',
'PALA-00122.38',
'PALA-00122.48',
'PALA-00123.38',
'PALA-00124.10',
'PALA-00124.22',
'PALA-00126.22',
'PALA-00126.51',
'PALA-00129.22',
'PALA-00129.51',
'PALA-00134.74',
'PALA-00140.74',
'PALA-00142.74',
'PALA-00151.74',
'PALA-00159.10',
'PALA-00160.22',
'PALA-01029.22',
'PALA-01337.22',
'PALA-01502.22',
'PALA-01712.22',
'PALA-02096.22',
'PALA-02110.22',
'PALA-02479.22',
'PALA-03544.22',
'PALA-03649.22',
'PALA-04231.22',
'PALA-04345.22',
'PALA-04367.22',
'PALA-05163.22',
'PALA-06766.22',
'PALA-07160.22',
'PALA-08091.22',
'PALA-08321.22',
'PALA-09061.22',
'PALA-09513.22',
'PALA-99225.22',
'PC41500.50E',
'PE-AT.38.INT',
'PE-AT.41.INT',
'PE-AT.51.INT',
'PE-AT.60.INT',
'PE-AT.61.INT',
'PHC.45',
'PHC.77',
'PIT190.01',
'PIT190.04',
'PIT22002.03',
'PIT25110.01',
'PIT25110.45',
'PIT25110.50',
'PIT288110.45',
'PIT3022.45',
'PIT3033.45',
'PIT305110.45',
'PIT3066.45',
'PIT3510.45',
'PIT3560.01',
'PIT3560.45',
'PIT3565.01',
'PIT3565.45',
'PIT3580.01',
'PIT3580.45',
'PIT372002.03',
'PIT4292.04',
'PIT4686.01',
'PIT4686.45',
'PIT4686.50',
'PIT4687.01',
'PIT4687.45',
'PIT49030.10',
'PIT5142.01',
'PIT5142.04',
'PIT7462.45',
'PIT7476.01',
'PPG4014-601A.B98',
'PPG-818.04',
'PRLX1.3A',
'PRLX2.3A',
'PRLX3.3A',
'PRLX4.3A',
'PRLX5.3A',
'PRLX6.3A',
'PRLX7.3A',
'PRLX8.3A',
'PRLX9.3A',
'PT43696-51.C6',
'PT52107-08.C6',
'PT52107-08.68',
'PT59000-51.C6',
'PT72868-20.T80',
'PX700-B-04.04',
'RCEB-00002.22',
'RCEB-00010.22',
'RCEB-00011.22',
'RCEB-00014.22',
'RCEB-00015.22',
'RCEB-00016.22',
'RCSA-00004.22',
'RCSA-00005.22',
'RCSA-00008.22',
'RCSA-00015.22',
'RCSA-00043.22',
'RCSA-00044.22',
'RCSA-00045.22',
'REHA-00014.22',
'RESB-00001.22',
'RESIDUO-18',
'RESIDUO-27',
'RNSB-00002.22',
'RR73B.77',
'RU120.INT',
'RV3510.50',
'RV3545.01',
'RV3545.45',
'RV3545.50',
'RV3555.45',
'RV3555.50',
'RV3560.01',
'RV3575.01',
'RV3575.45',
'RV3575.50',
'RV3580.50',
'SL010.11',
'SL020.11',
'SL500.11',
'SO-001',
'SO-003',
'SO-027',
'SPTS-00001.97',
'SPTS-000041.48',
'SPTS-000042.48',
'SPTS-00006.22',
'SPTS-00006.71',
'SPTS-00006.97',
'SPTS-00008.97',
'SPTS-00011.63',
'SPTS-00016.77',
'SPTS-00031.57',
'SPTS-00034.97',
'SPTS-00036.63',
'SPTS-00037.22',
'SPTS-00037.48',
'SPTS-00037.97',
'SPTS-00038.22',
'SPTS-00039.59',
'SPTS-00040.97',
'SSE-255.INT',
'STCL247.97',
'SU44090.INT',
'TF1101.04',
'TF1101.10',
'TF1102.04',
'TF-2016BR.52',
'TG-0923.L95',
'TG-0938.52',
'TG-0940.52',
'TG-0945.L95',
'TG-0948.50',
'TG-0962.L95',
'TG-0965.50',
'TG140.37',
'TG-1512.52',
'TG-1516.52',
'TG200.37',
'TG300.37',
'TOEB-00001.48',
'TOEB-00001.50',
'TOEB-00006.97',
'TOEB-00010.S5',
'TOEB-00011.97',
'TOEB-00013.65',
'TOEB-00014.48',
'TOEB-00015.40',
'TOEB-00015.48',
'TOHB-215WS.T91',
'TOPB-00013.46',
'TORD-00003.77',
'TOSA-LPP1SO.10',
'TOSA-NK53KC.51',
'TOSA-NK53K.48',
'TOSA-NK53SC.48',
'TOSA-NK53SC.51',
'TOSA-NK53S.48',
'TOSA-SD60K.51',
'TOSA-SD60S.51',
'TOSA-TSS3IN.48',
'TOSA-TSS3K.48',
'TOSA-TSW3K.48',
'TOSA-TSW3K.97',
'TOSA-TSW3S.48',
'TOSA-00017.48',
'TOSA-00019.48',
'TOSA-00019.51',
'TOSA-00021.48',
'TOSA-00023.48',
'TOSA-00025.48',
'TOSA-00027.48',
'TOSA-00029.48',
'TOSA-00029.51',
'TOSA-00031.48',
'TOSA-00031.51',
'TOSA-00033.48',
'TOSA-00033.51',
'TOSA-00034.50',
'TOSA-00035.50',
'TOSA-00036.50',
'TOSA-00037.50',
'TOSA-00039.50',
'TOSA-00044.10',
'TOSA-00045.10',
'TOSA-00046.10',
'TOSA-00053.10',
'TOSA-00054.50',
'TOSA-00055.10',
'TOSA-1210S.48',
'TOSA-13RCS.48',
'TOSA-3331K.51',
'TOSA-5A3MS.51',
'TOSA-7172K.51',
'TOSB-00001.38',
'TOSB-00003.11',
'TOSB-1210R.11',
'TOSB-500AR.10',
'TOSB-500AR.51',
'TOSB-500TL.10',
'TOSB-500TL.51',
'TOSB-6100K.10',
'TOSB-6100K.51',
'TOVA-00008.C8',
'TOZA-070BP.04',
'TOZA-070MC.04',
'TOZA-3R3BP.04',
'T497.65',
'T499.74',
'UGA.70',
'UT32.C6',
'UT32.68',
'UT32.70',
'UT32.97',
'UT92D.C6',
'UT92D.68',
'UT95WP.C6',
'UT95WP.68',
'UT95WP.77',
'UY5300.45',
'VWSA-00004.10',
'VWSB-00001.10',
'XB14030.52',
'XB4000DM.70',
'XB4000DR.68',
'XB4000DR.70',
'XB4000SM.70',
'XB4000SR.68',
'XB4000SR.70',
'ZBADDED.70',
'ZBADDED.97',
'ZBADDZR.70',
'ZB4200DM.97',
'ZB4200DR.70',
'ZB4200DR.97',
'ZB4200SM.68',
'ZB4200SR.68',
'ZM477.INT',
'04339000-GPRA',
'043695-0001',
'1TMC42453.48',
'102400L.20',
'102670L.10',
'102689.65',
'104066.75',
'106205.11',
'107225.75',
'108309L.20',
'109352.11',
'11210.45',
'113191L.20',
'114144.75',
'114963.75',
'115170.75',
'115352L.10',
'115649L.48',
'117246.11',
'117801.75',
'118335.75',
'119507L.10',
'121186L.10',
'121975.75',
'122506.75',
'12770034L.04',
'128821L.10',
'1409109.45',
'141100L.01',
'1419109.45',
'142014L.10',
'142014.01',
'142014.10',
'153215.76',
'153216.76',
'153218.02',
'153221.02',
'153223.02',
'153225.02',
'153228.02',
'153234.02',
'153237.02',
'155.01',
'155.04',
'167581.01',
'188110.45',
'188110.50',
'190.01',
'190.04',
'191905L.04',
'195842.01',
'20110.45',
'20110.50',
'202389L.04',
'202721.01',
'202722.04',
'204697.10',
'204698.10',
'204699.10',
'204700.10',
'204958.10',
'204960.10',
'204961.10',
'204962.10',
'204963.10',
'204965.10',
'204966.10',
'204967.10',
'204968.10',
'215871L.10',
'22002.03',
'22002.10',
'220294L.04',
'231302L.04',
'231302L.10',
'238-5/66',
'247743.11',
'247744.11',
'247747.02',
'250044.01',
'25110.01',
'25110.04',
'25110.45',
'25110.50',
'26300034L.04',
'26300034L.10',
'269306L.20',
'283299L.31',
'288110.01',
'288110.45',
'288110.50',
'288956L..20',
'30110.45',
'305110.50',
'30565.45',
'317124.05',
'32-0007.1Q',
'32-0009',
'324594.01',
'334907.01',
'336129.11',
'3565.01',
'372002.03',
'372002.10',
'388110.45',
'40687.45',
'418664.04',
'4292.04',
'44090.03',
'4680.INT',
'4680.26',
'4680.38',
'4686.01',
'49030.10',
'49030.50',
'5500045L.48',
'605110.45') OR
msi.segment1 in ('692.01',
'692.45',
'692.50',
'4686.04',
'4686.45',
'4686.50',
'4687.50',
'7900.L95',
'7949.T80',
'7957.L95',
'8002002.03',
'8201593984',
'8201608588.00',
'8201659243.00',
'8201659259',
'8229210.50',
'8-3538.1G',
'8724086.03',
'9062002.03',
'96-10.04',
'96-10.11',
'96-12.04',
'96-12.11',
'96-13.04',
'96-13.11',
'96-2.04',
'96-2.11',
'96-22.04',
'96-22.11',
'96-23.04',
'96-26.04',
'96-26.11',
'96-3.04',
'96-3.11',
'96-4.04',
'96-4.11',
'96-5.04',
'96-5.11',
'96-6.04',
'96-6.11',
'96-7.04',
'96-7.11',
'99910006.22'))
           --
           --msi.segment1 = '8201144982.99' --'TOEA-6247Z.79' --'8201144996.99' --'8201540330.99' --'TOEA-6247Z.79'
           --msi.inventory_item_id        = 2701
--           
--
    UNION ALL
--    
    -- Parte RECURSIVA
--
--
    SELECT c.segment1,
           fmdi.inventory_item_id,
--    
           case 
              when fmdi.scale_type = 0 then
                 ((fmdi.qty / fmi.qty) / vri.std_qty) * c.qty
              else
                 (fmdi.qty / fmi.qty) * c.qty
           end qty ,
           fmdi.formula_id,
           gri.recipe_id,
           fmdi.organization_id,      
           c.nivel + 1
--           
      FROM apps.fm_form_mst_b fmsi
      join apps.fm_matl_dtl   fmi  
        on NVL(fmsi.formula_class,'SM') <> 'TING-PMC' AND
           fmsi.formula_id               = fmi.formula_id
--
      join apps.gmd_recipes_b gri
        on gri.recipe_status        in (700,900)            AND
           gri.recipe_id            = (select max(gr1.recipe_id)
                                         FROM apps.gmd_recipes_b gr1,
                                              apps.gmd_recipe_validity_rules vr1
                                        WHERE vr1.delete_mark                 = 0                   AND
                                              vr1.preference                  = 1                   AND      
                                              vr1.recipe_use                  = 0 /*Custos*/       AND -- 0 = Produção    2 = Custos
                                              vr1.validity_rule_status       in (700,900)           AND
                                              vr1.start_date                 <= sysdate             AND
                                              vr1.end_date                   is NULL                AND
                                              vr1.organization_id             = fmi.organization_id AND
                                              vr1.recipe_id                   = gr1.recipe_id       AND
                                              gr1.recipe_status              in (700,900)           AND
                                              gr1.formula_id                  = fmi.formula_id)       
--                   
--
      join apps.gmd_recipe_validity_rules vri
        on /**** performance ****/
           vri.preference                  = 1                   AND      
           vri.delete_mark                 = 0                   AND
           vri.recipe_use                  = 0                   AND -- 0=Producao   2=Custos 
           vri.validity_rule_status       in (700,900)           AND 
           vri.start_date                 <= sysdate             AND
           NVL(vri.end_date,(SYSDATE + 1)) > sysdate             AND
           vri.organization_id             = fmi.organization_id AND           
           vri.recipe_id                   = gri.recipe_id
           /**** performance ****/
--           
      join apps.fm_matl_dtl fmdi
        on fmdi.line_type           = -1                    AND
           fmdi.formula_id          = fmi.formula_id        AND
           fmdi.formula_id          = gri.formula_id        AND
           fmdi.organization_id     = fmi.organization_id   AND
           fmdi.CONTRIBUTE_YIELD_IND   = 'Y'
--
--           
      join apps.mtl_system_items_b msii
        on fmi.inventory_item_id   = msii.inventory_item_id AND
           fmi.line_type           = 1                      AND
           msii.inventory_item_id  = fmi.inventory_item_id  AND
           msii.organization_id    = fmi.organization_id 
           --
--           
      join  cteMenuNivel c 
        on msii.inventory_item_id = c.inventory_item_id AND
           fmdi.inventory_item_id <> c.inventory_item_id and
           c.nivel                < 20
--
)      
--
--cycle inventory_item_id set is_cycle to '1' default '0'
--
SELECT c.segment1,
       c.nivel,
       msi.segment1 Ingrediente,
       msi.primary_uom_code,
       msi.item_type,
       --c.formula_id,
       --c.inventory_item_id,
       c.qty,
       --c.Nivel,
--       
       MSI.GLOBAL_ATTRIBUTE2       "Classe da Cond da Transação",
       MSI.GLOBAL_ATTRIBUTE3       "Origem do Item",
       MSI.GLOBAL_ATTRIBUTE4       "Tipo Fiscal do Item",
--       MSI.GLOBAL_ATTRIBUTE6       "Situação Trib Estadual",
--      MSI.GLOBAL_ATTRIBUTE5       "Situação Trib Federal",
--      MSI.GLOBAL_ATTRIBUTE10      "EAN13",
--       MSI.GLOBAL_ATTRIBUTE16      "Importar Conteudo",
--       MSI.GLOBAL_ATTRIBUTE17      "Valor Parcela estrangeira",
--       MSI.GLOBAL_ATTRIBUTE18      "Valor Total Envio Inter",
--       MSI.GLOBAL_ATTRIBUTE19      "Numero FCI",       
       FISCAL_CLASSIFICATION.CATEGORIA "NCM"       
--       
--       
--       
  FROM cteMenuNivel c, apps.mtl_system_items_b msi,
       (SELECT MIC.INVENTORY_ITEM_ID,
               MIC.ORGANIZATION_ID,
               MIC.CATEGORY_SET_NAME,
               MIC.CATEGORY_CONCAT_SEGS CATEGORIA
          FROM APPS.MTL_ITEM_CATEGORIES_V MIC, APPS.MTL_CATEGORIES_V MC
         WHERE MC.CATEGORY_ID = MIC.CATEGORY_ID
           AND MIC.CATEGORY_SET_NAME IN ('FISCAL_CLASSIFICATION')) FISCAL_CLASSIFICATION
 WHERE msi.inventory_item_id      = c.inventory_item_id AND
       msi.organization_id        = c.organization_id   AND
       msi.planning_make_buy_code = 2                   AND
       msi.primary_uom_code       = 'kg' AND
     --  msi.item_type             <> 'INS/EMB'           AND
     --  msi.item_type             <> 'MISC'           AND
       MSI.ORGANIZATION_ID        = FISCAL_CLASSIFICATION.ORGANIZATION_ID(+) AND
       MSI.INVENTORY_ITEM_ID      = FISCAL_CLASSIFICATION.INVENTORY_ITEM_ID(+)
   --    and msi.PRIMARY_UOM_CODE = 'kg' and msi.ITEM_TYPE = 'MP'
       order by 1,2,3;

select * from apps.mtl_system_items_b where segment1 in ('SRC-75','HE-15-8633');